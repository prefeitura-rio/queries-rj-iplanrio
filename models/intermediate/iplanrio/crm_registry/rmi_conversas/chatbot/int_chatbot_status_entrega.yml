version: 2

models:
  - name: int_chatbot_status_entrega
    description: "Status de entrega consolidado das tabelas fluxo_atendimento mensais"
    
    columns:
      - name: id_hsm
        description: "ID da HSM (triggerId)"
        tests:
          - not_null
          
      - name: telefone_contato
        description: "Telefone de destino (flatTarget)"
        
      - name: status_entrega
        description: "Status da entrega"
        
      - name: envio_datahora
        description: "Timestamp de envio ajustado para fuso horário local"

    tests:
      # Test de cardinalidade: não deve ter muitos registros por HSM
      - dbt_utils.expression_is_true:
          expression: "
            (select max(hsm_count) from (
              select count(*) as hsm_count 
              from {{ this }} 
              group by id_hsm
            )) <= 50000
          "
          config:
            error_if: ">= 1"
            
      # Test de integridade temporal
      - dbt_utils.expression_is_true:
          expression: "
            (select count(*) from {{ this }} 
             where envio_datahora > current_timestamp()) = 0
          "